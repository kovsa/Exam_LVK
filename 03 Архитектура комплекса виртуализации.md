# **3.1 Состав комплекса виртуализации. Средний уровень**

ЛВК состоит из двух сайтов, обладающих равнозначными техническими характеристиками. 

В состав каждого сайта входят следующие компоненты:
- Серверная вычислительная система (СВС);
- Система хранения данных (СХД);
- Сеть хранения данных (SAN);
- Среда виртуализации.

В состав СВС каждого сайта ЛВК входят 3 стоечных серверов (Rack-mount) под виртуализацию (Lenovo SR650).

В качестве типовой для каждого сайта ЛВК используется Yadro CX1-30 (31,32,33) (аналог IBM Storwize V5000) в конфигурации : 
- одно головное устройство СХД с 24-мя жесткими дисками, 
- одна полка расширения с 24-мя жесткими дисками.

Суммарно на каждом сайте в СХД используется 48 жестких дисков.


SAN состоит из двух коммутаторов (Lenovo B6505) на каждом сайте ЛВК. Коммутаторы объединены в две фабрики, "растянутые" между сайтами.

В состав среды виртуализации для ЛВК входит следующее системное ПО:
- **VMware ESXi**. Специализированная ОС, гипервизор. Используется по количеству физических серверов СВС. Лицензируется по количеству процессорных сокетов, т.е. на каждый сервер используется две лицензии.
- **vCenter Server**. ПО централизованного администрирования, мониторинга среды виртуализации, сервер автоматизации управления исправлениями. Устанавливается совместно с другими компонентами, подробности можно почитать в [vCenter Server and Host Management](https://docs.vmware.com/en/VMware-vSphere/6.7/vsphere-esxi-vcenter-server-67-host-management-guide.pdf) начиная со стр.13. 
- **Platform Services Controller (PSC)**. Реализует механизм Single Sign-On, то есть единую авторизацию во все компоненты виртуальной среды. Начиная с версии 6.5 Update 2 рекомендуется не выделять его в отдельную виртуальую машину, а устанавливать вместе с vCenter [vCenter Server Components and Services](https://docs.vmware.com/en/VMware-vSphere/6.7/com.vmware.vcenter.install.doc/GUID-78933728-7F02-43AF-ABD8-0BDCE10418A6.html). Дополнительно можно почитать [тут](https://medium.com/@pryalukhin/vmware-psc-under-the-hood-51917f72dead) и [тут](https://www.vmgu.ru/news/vmware-vcenter-6-new-architecture). Настоятельно рекомендую вдумчиво ознакомиться с поддерживаемыми топологиями в [Supported and deprecated topologies for VMware vSphere 6.5](https://kb.vmware.com/s/article/2147672)
- **Site Recovery Manager (SRM)**. ПО автоматизации аварийного восстановления. 

VMware предоставляет три основные кластерные технологии [Introduction to VMware DRS and VMware HA Clusters](https://pubs.vmware.com/vsphere-50/index.jsp?topic=%2Fcom.vmware.wssdk.pg.doc_50%2FPG_Ch13_Resources.15.6.html):
- **VMware High Availability (HA)**. Обеспечивает высокую доступность. Подробнее можно почитать в [vSphere Availability](https://docs.vmware.com/en/VMware-vSphere/6.7/vsphere-esxi-vcenter-server-671-availability-guide.pdf) страницы 11-26.
- **VMware Distributed Resource Scheduler (DRS)**. Обеспечивает балансировку нагрузки на CPU и RAM. Подробнее в [vSphere Resource Management](https://docs.vmware.com/en/VMware-vSphere/6.7/vsphere-esxi-vcenter-server-67-resource-management-guide.pdf), [DRS Enhancements in vSphere 6.7](https://www.vmware.com/content/dam/digitalmarketing/vmware/en/pdf/techpaper/performance/drs-enhancements-vsphere67-perf.pdf), [VMware DRS tips and tricks](https://4sysops.com/archives/vmware-drs-tips-and-tricks/).
- **VMware Storage DRS**. Балансировка нагрузки на СХД. Подробнее в [VMware vSphere Storage DRS Interoperability](https://www.vmware.com/techpapers/2012/vmware-vsphere-storage-drs-interoperability-10286.html)

Максимально полное и подробное описание работы кластеров Vmware есть в книге Duncan Epping [VMware vSAN 6.7 U1 Deep Dive](https://www.amazon.com/gp/product/B07L8CNZ53/ref=dbs_a_def_rwt_hsch_vapi_tkin_p1_i0). 

С точки зрения кластеров гостевых ОС, необходимо знать, что могут быть кластеры:
- Высокой доступности (MSCS failover Cluster, AlwaysOn). Кластеры могут быть с общим диском и без.
- Балансировки нагрузки (NLB). 

Подробнее [тут](https://www.pcweek.ua/themes/detail.php?ID=120798)
----------------------------------------------------------------------------------

# **3.2 Требования, предъявляемые к комплексу виртуализации. Средний уровень**

ЛВК являются ИУС категории оперативного обслуживания 1.
Режим работы ЛВК – круглосуточный.

- режим функционирования **Штатный** (уровень критичности «0») соответствует основному режиму функционированию;
- режим функционирования **Угроза** (уровень критичности «1») соответствует периоду от момента обнаружении эксплуатирующим персоналом потенциальной возможности отказа компоненты модуля ЦОД до момента перевода ЦОД в другие режимы функционирования;
- режим функционирования **Аварийный** (уровень критичности «2») соответствует периоду от момента появления единичного сбоя компоненты ЦОД или видов катастроф, входящих в перечень защищаемых ситуаций, до момента перевода ЦОД в другие режимы функционирования;
- режим функционирования **Профилактический** (уровень критичности «3»)соответствует периоду планового снижение резерва с сохранением основной функциональности ЦОД и обеспечения штатного функционирования размещенных на нем ИУС, находящихся в ПЭ с целью проведения планового (периодического) сервисного обслуживания до момента перевода ЦОД в другие режимы функционирования;
- режим функционирования **Нештатный** (уровень критичности «4») соответствует периоду от проявления единовременно множественных отказов компонент ЦОД до момента перевода ЦОД в другие режимы функционирования

На оборудовании ЛВК должны быть установлены рекомендуемые производителем оборудования и стабильно работающие версии микрокодов (firmware). Данные версии должны загружаться филиалом с сайта производителя оборудования или запрашиваться у организации, осуществляющей техническую поддержку оборудования. Версии прошивок должны фиксироваться в Реестре микрокодов серверного оборудования (не позднее 1 (одного) рабочего дня с момента их установки), и в паспорте ЛВК (не позднее 1 (одного) месяца с момента их установки).

Версии гипервизоров VMware ESXi должны быть одинаковыми на всех серверах сайта и поддерживаться с помощью VMware Update Manager в актуальном состоянии.

Обновление микрокодов и версий гипервизоров необходимо производить не реже одного раза в год. 

Для обеспечения отказоустойчивости соединения между виртуальным коммутатором и физическими коммутаторами ЛВС каждый виртуальный коммутатор должен использовать как минимум два физических интерфейса сервера. 
Распределение интерфейсов:
- два интерфейса выделяются для стандартного виртуального коммутатора (Standard vSwitch), с типом трафика Management Network (port-channel static = Route based on IP Hash);
-	два интерфейса выделяются в распределенный коммутатор (Distributed vSwitch) для трафика vMotion и Virtual Machine Network (port-channel lacp).

Оптические коммутаторы объединяются в **две** фабрики коммутации, коммутаторы одной фабрики должны иметь между собой минимум **два** соединения в качестве ISL. 

На оптических коммутаторах должно быть настроено зонирование для сегментации трафика SAN:
1.	Объединение портов серверов и СХД. Каждый порт оптического адаптера каждого сервера  сайта объединяется с одним портом обоих контроллеров СХД сайта.
1. Объединение портов для Internode взаимодействия контроллеров СХД и репликации СХД первого сайта на СХД второго сайта.
------------------------------------------------------------------------------------------------------------------------

# **3.3 Обеспечение отказоустойчивого функционирования комплекса виртуализации. Высокий уровень** 

1. Отказоустойчивость СХД обеспечивается за счет:
  - Выбора качественного оборудования бренда класса А
  - Избыточности компонентов СХД (2 блока питания, два контроллера)
  - Избыточности сетевых подключений (по два соединения FC на каждом контроллере)
  - Использования технологий RAID или Distributed RAID, обеспечивающих избыточность хранения данных на дисках
  - Поддержки технологии Multipathing
  - Своевременного регламентного обслуживания
2. Отказоустойчивость SAN обеспечивается за счет:
  - Выбора качественного оборудования бренда класса А
  - Избыточности оборудования и организации двух независимых фабрик
  - Избыточности соединений в ISL
  - Своевременного регламентного обслуживания
3. Отказоустойчивость СВС обеспечивается за счет:
  - Выбора качественного оборудования бренда класса А
  - Избыточности компонентов серверов (2 блока питания)
  - Избыточности сетевых подключений
  - Своевременного регламентного обслуживания
4. Отказоустойчивость среды виртуализации обеспечивается за счет:
  - Выбора качественного программного продукта среды виртуализации (VMware)
  - Использования кластера высокой доступности VMware HA
  - Поддержки сетевых технологий балансировки и отказоустойчивости (nic teaming, ether-channel, lacp, STP и т.д.)
  - Возможности централизованного управления сетевыми настройками на распределенном коммутаторе
  - Поддержке технологий Multipathing
  - Поддержания в актуальном состоянии версий ПО


